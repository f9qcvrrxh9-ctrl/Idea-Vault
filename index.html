<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Whimsy Vault</title>
    
    <style>
        :root {
            --c0: #F9C469; --c1: #FAA874; --c2: #FB8C7F;
            --c3: #FC708A; --c4: #FD5495; --c5: #FE38A0;
            --v0: #1a0a24; --v1: #140a24; --v2: #0a1124; 
            --v3: #0a2024; --v4: #0a2417; --v5: #241b0a; 

            --active-accent: var(--c0);
            --active-vibe: var(--v5);
            --filter-accent: var(--warm-white);
            --glass: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.18);
            --warm-white: #e8e6e1;
            --orb-x: 50%; --orb-y: -10%;
        }

        body {
            margin: 0; background-color: #050508; color: white;
            font-family: -apple-system, system-ui, sans-serif;
            min-height: 100vh; overflow-x: hidden;
            -webkit-user-select: none;
        }

        .vibe-orb {
            position: fixed; 
            top: var(--orb-y); left: var(--orb-x); 
            transform: translate(-50%, -50%);
            width: 160%; height: 70%;
            background: radial-gradient(circle, var(--active-vibe) 0%, transparent 80%);
            filter: blur(90px); z-index: -1; 
            transition: all 2s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .app-container { padding: 80px 25px 120px; max-width: 420px; margin: auto; }

        /* --- Input Receptor (Fixing the Glow Cutoff) --- */
        .input-box {
            background: var(--glass); border-radius: 32px; padding: 25px;
            backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
            border: 1px solid var(--border);
            /* Massive shadow with extra spread to prevent clipping */
            box-shadow: 0 30px 60px rgba(0,0,0,0.6), 0 0 40px var(--active-accent);
            transition: all 0.8s ease;
            /* Force GPU rendering to prevent invisible clipping lines */
            transform: translateZ(0);
            will-change: box-shadow;
        }

        textarea {
            width: 100%; height: 160px; background: transparent; border: none;
            color: white; font-size: 20px; outline: none; resize: none;
            font-family: inherit; font-weight: 300; line-height: 1.5;
            overflow-y: auto; scrollbar-width: none;
        }
        textarea::-webkit-scrollbar { display: none; }

        .icon-row { display: flex; justify-content: space-between; margin: 30px 0; gap: 8px; }

        .sq-btn {
            width: 44px; height: 44px; border-radius: 14px;
            border: 1px solid var(--border); background: var(--glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.5s cubic-bezier(0.2, 1, 0.3, 1); padding: 0;
        }

        .ic0 svg { fill: var(--c0); } .ic1 svg { fill: var(--c1); }
        .ic2 svg { fill: var(--c2); } .ic3 svg { fill: var(--c3); }
        .ic4 svg { fill: var(--c4); } .ic5 svg { fill: var(--c5); }

        .sq-btn svg { width: 20px; height: 20px; opacity: 0.6; transition: 0.4s; }
        .sq-btn.active { transform: scale(1.2) translateY(-6px); border-color: white; }
        
        #inputIcons .sq-btn.active { box-shadow: 0 0 25px var(--active-accent); }
        #inputIcons .sq-btn:not(.active) svg { opacity: 0.35; }

        /* Save Button (Tightened Margin) */
        .save-btn {
            width: 100%; padding: 22px; border-radius: 22px; 
            background: rgba(0, 0, 0, 0.5); border: 1px solid var(--active-accent);
            color: var(--active-accent); text-shadow: 0 0 15px var(--active-accent);
            font-weight: 800; text-transform: uppercase; letter-spacing: 4px; font-size: 13px;
            transition: all 0.6s ease; 
            margin-bottom: 45px; /* Pulled Archive up by 25px */
        }

        /* --- Archive UI (Tightened Spacing) --- */
        .archive-header { font-size: 10px; text-transform: uppercase; letter-spacing: 5px; opacity: 0.3; margin-bottom: 15px; text-align: center; }

        #searchWrapper {
            background: rgba(255,255,255,0.04); border-radius: 20px; padding: 15px 20px;
            border: 1px solid var(--border); margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 0 20px var(--filter-accent); transition: box-shadow 0.6s ease;
        }
        #searchWrapper input { background: transparent; border: none; color: white; width: 80%; outline: none; font-size: 17px; }

        .all-txt { font-size: 10px; font-weight: 900; text-transform: uppercase; color: var(--warm-white); opacity: 0.7; }
        #filterIcons .all-btn.active .all-txt { opacity: 1; text-shadow: 0 0 10px var(--warm-white); }
        #filterIcons .all-btn.active { box-shadow: 0 0 15px rgba(232, 230, 225, 0.3); }

        #filterIcons .ic0.active { box-shadow: 0 0 15px var(--c0); }
        #filterIcons .ic1.active { box-shadow: 0 0 15px var(--c1); }
        #filterIcons .ic2.active { box-shadow: 0 0 15px var(--c2); }
        #filterIcons .ic3.active { box-shadow: 0 0 15px var(--c3); }
        #filterIcons .ic4.active { box-shadow: 0 0 15px var(--c4); }
        #filterIcons .ic5.active { box-shadow: 0 0 15px var(--c5); }

        .note {
            background: rgba(255,255,255,0.04); border-radius: 25px; padding: 25px; 
            margin-top: 20px; border-left: 4px solid var(--note-color);
            backdrop-filter: blur(15px); animation: noteAppear 0.5s cubic-bezier(0.2, 1, 0.3, 1) forwards;
        }

        @keyframes noteAppear { from { opacity: 0; transform: scale(0.95) translateY(15px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .note-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .note-tag { font-size: 11px; font-weight: 900; color: var(--note-color); text-transform: uppercase; letter-spacing: 2px; }
        .note-date { font-size: 10px; opacity: 0.3; font-weight: 700; }
        .note-body { font-size: 17px; line-height: 1.6; opacity: 0.85; font-weight: 300; }
        .preview-text { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        .action-row { display: flex; gap: 20px; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 15px; }
        .action-btn { background: transparent; border: none; font-size: 12px; font-weight: 700; color: white; opacity: 0.4; cursor: pointer; text-transform: uppercase; }
        .action-btn.del { color: #ff453a; }
    </style>
</head>
<body>

    <div class="vibe-orb" id="vibeOrb"></div>

    <div class="app-container">
        <div class="input-box">
            <textarea id="noteInput" placeholder="New thought..."></textarea>
        </div>
        <div class="icon-row" id="inputIcons"></div>
        <button class="save-btn" id="saveAction" onclick="saveNote()">Save to Vault</button>

        <div class="archive-header">Archive</div>
        <div id="searchWrapper">
            <input type="text" id="searchInput" placeholder="Search entries..." oninput="renderNotes()">
            <button onclick="exportFilteredNotes()" style="background:none; border:none; opacity:0.6;"><svg width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
        </div>

        <div class="icon-row" id="filterIcons">
            <button class="sq-btn all-btn active" onclick="changeFilter('All', this, 'var(--warm-white)')"><span class="all-txt">All</span></button>
        </div>

        <div id="notesList"></div>
    </div>

    <script>
        const svgs = [
            '<svg viewBox="0 0 24 24"><path d="M12 2c5.52 0 10 4.48 10 10s-4.48 10-10 10-10-4.48-10-10 4.48-10 10-10zm0 18c4.41 0 8-3.59 8-8s-3.59-8-8-8-8 3.59-8 8 3.59 8 8 8zm-3.5-9c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zm7 0c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zm-3.5 6c2.33 0 4.31-1.46 5.11-3.5h-10.22c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>',
            '<svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C8.29 12.18 7 10.65 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.65-1.29 3.18-3.15 4.1z"/></svg>',
            '<svg viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"/></svg>',
            '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>',
            '<svg viewBox="0 0 24 24"><path d="M15.5 14c1.51 0 2.85-.75 3.66-1.89l1.41 1.41C19.45 14.64 17.58 16 15.5 16c-3.03 0-5.5-2.47-5.5-5.5 0-2.08 1.36-3.95 3.48-5.07l1.41 1.41C13.75 7.65 13 8.99 13 10.5c0 1.93 1.57 3.5 3.5 3.5zm-7 2c-3.03 0-5.5-2.47-5.5-5.5 0-2.08 1.36-3.95 3.48-5.07l1.41 1.41C7.25 7.65 6.5 8.99 6.5 10.5c0 1.93 1.57 3.5 3.5 3.5 1.51 0 2.85-.75 3.66-1.89l1.41 1.41C13.95 14.64 12.08 16 10 16z"/></svg>',
            '<svg viewBox="0 0 24 24"><path d="M12 15.5l-1.5-3.5L7 10.5 10.5 9 12 5.5l1.5 3.5L17 10.5l-3.5 1.5L12 15.5zM19 9.5l-1.25-2.75L15 5.5l2.75-1.25L19 1.5l1.25 2.75L23 5.5l-2.75 1.25L19 9.5zM6 21.5l-1-2.25L2.75 18.25l2.25-1L6 15l1 2.25 2.25 1-2.25 1L6 21.5z"/></svg>'
        ];

        const tagColors = ['var(--c0)', 'var(--c1)', 'var(--c2)', 'var(--c3)', 'var(--c4)', 'var(--c5)'];
        const tagMoods = ['var(--v0)', 'var(--v1)', 'var(--v2)', 'var(--v3)', 'var(--v4)', 'var(--v5)'];
        const tagLabels = ["Funny", "Idea", "Remember", "Fact", "Coincidences", "Other"];
        const orbRadialPath = [['30%','10%'], ['70%','10%'], ['85%','35%'], ['70%','65%'], ['30%','65%'], ['15%','35%']];

        let writeIdx = 0; let archiveFilter = 'All'; let editingId = null;

        svgs.forEach((svg, i) => {
            const b1 = document.createElement('button');
            b1.className = `sq-btn ic${i}`; b1.innerHTML = svg;
            b1.onclick = () => {
                writeIdx = i;
                document.documentElement.style.setProperty('--active-accent', tagColors[i]);
                document.documentElement.style.setProperty('--active-vibe', tagMoods[5-i]);
                document.documentElement.style.setProperty('--orb-x', orbRadialPath[i][0]);
                document.documentElement.style.setProperty('--orb-y', orbRadialPath[i][1]);
                document.querySelectorAll('#inputIcons .sq-btn').forEach((b, idx) => b.classList.toggle('active', idx===i));
            };
            document.getElementById('inputIcons').appendChild(b1);

            const b2 = document.createElement('button');
            b2.className = `sq-btn ic${i}`; b2.innerHTML = svg;
            b2.onclick = () => changeFilter(tagLabels[i], b2, tagColors[i]);
            document.getElementById('filterIcons').appendChild(b2);
        });

        function changeFilter(f, btn, accent) {
            archiveFilter = f;
            document.documentElement.style.setProperty('--filter-accent', accent);
            document.querySelectorAll('#filterIcons .sq-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderNotes();
        }

        function saveNote() {
            if (window.navigator.vibrate) window.navigator.vibrate(15);
            const val = document.getElementById('noteInput').value.trim();
            if(!val) return;
            let data = JSON.parse(localStorage.getItem('vaultData')) || [];
            if(editingId) {
                const idx = data.findIndex(n => n.id === editingId);
                if(idx !== -1) { data[idx].text = val; data[idx].tag = tagLabels[writeIdx]; data[idx].color = tagColors[writeIdx]; }
                editingId = null; document.getElementById('saveAction').innerText = "Save to Vault";
            } else {
                data.unshift({ id: Date.now(), text: val, tag: tagLabels[writeIdx], color: tagColors[writeIdx], date: new Date().toLocaleDateString('en-GB', {day:'numeric', month:'short'}) });
            }
            localStorage.setItem('vaultData', JSON.stringify(data));
            document.getElementById('noteInput').value = ""; renderNotes();
        }

        function deleteNote(id) {
            if(!confirm("Delete forever?")) return;
            let data = JSON.parse(localStorage.getItem('vaultData')) || [];
            localStorage.setItem('vaultData', JSON.stringify(data.filter(n => n.id !== id)));
            renderNotes();
        }

        function editNote(id) {
            const data = JSON.parse(localStorage.getItem('vaultData')) || [];
            const n = data.find(note => note.id === id);
            document.getElementById('noteInput').value = n.text;
            editingId = id; document.getElementById('saveAction').innerText = "Update Note";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleExpand(btn) {
            const body = btn.closest('.note').querySelector('.note-body');
            body.classList.toggle('preview-text');
            btn.innerText = body.classList.contains('preview-text') ? "Read More" : "Collapse";
        }

        function renderNotes() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const data = JSON.parse(localStorage.getItem('vaultData')) || [];
            const filtered = data.filter(n => (archiveFilter === 'All' || n.tag === archiveFilter) && n.text.toLowerCase().includes(query));
            const list = document.getElementById('notesList');
            list.innerHTML = "";
            filtered.forEach(n => {
                const div = document.createElement('div'); div.className = "note"; div.style.setProperty('--note-color', n.color);
                div.innerHTML = `
                    <div class="note-header"><span class="note-tag">${n.tag}</span><span class="note-date">${n.date}</span></div>
                    <div class="note-body preview-text">${n.text.replace(/\n/g, '<br>')}</div>
                    <button class="action-btn" style="margin-top:10px; opacity:0.7; color:${n.color}" onclick="toggleExpand(this)">Read More</button>
                    <div class="action-row">
                        <button class="action-btn" onclick="editNote(${n.id})">Edit</button>
                        <button class="action-btn del" onclick="deleteNote(${n.id})">Delete</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function exportFilteredNotes() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const data = JSON.parse(localStorage.getItem('vaultData')) || [];
            const filtered = data.filter(n => (archiveFilter === 'All' || n.tag === archiveFilter) && n.text.toLowerCase().includes(query));
            let content = "WHIMSY VAULT EXPORT\n\n";
            filtered.forEach(n => content += `${n.date} [${n.tag}]\n${n.text}\n\n---\n\n`);
            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob);
            link.download = `Vault_Export.txt`; link.click();
        }

        window.onload = () => { renderNotes(); document.getElementById('inputIcons').children[0].click(); };
    </script>
</body>
</html>
